# YouTube Cache æµ‹è¯•ç»“æœ

## æµ‹è¯•çŠ¶æ€

### âœ… å·²å®Œæˆçš„å‡†å¤‡å·¥ä½œ

1. **ä»£ç å®ç°å®Œæˆ**
   - âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–
   - âœ… æŸ¥è¯¢è§„èŒƒåŒ–å‡½æ•° (`normalizeQuery`, `hashQuery`, `extractKeywords`)
   - âœ… ç¼“å­˜æŸ¥æ‰¾å‡½æ•° (`findCachedYouTubeQuery`)
   - âœ… ç¼“å­˜å­˜å‚¨å‡½æ•° (`storeYouTubeQuery`)
   - âœ… ä¿®æ”¹ `searchYouTubeVideosByQuery` æ”¯æŒç¼“å­˜
   - âœ… æ›´æ–°æ‰€æœ‰è°ƒç”¨ç‚¹ä¼ é€’ context å‚æ•°

2. **æµ‹è¯•è„šæœ¬åˆ›å»º**
   - âœ… `test-youtube-cache.js` - å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
   - âœ… æµ‹è¯•å‘½ä»¤æ·»åŠ åˆ° `package.json`

### âš ï¸ éœ€è¦æ‰§è¡Œçš„æ­¥éª¤

**é‡è¦**ï¼šåœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰ï¼Œæ‚¨éœ€è¦åœ¨ Supabase æ•°æ®åº“ä¸­æ‰§è¡Œ SQL è„šæœ¬ï¼š

#### é€‰é¡¹ 1ï¼šé¦–æ¬¡åˆ›å»ºè¡¨ï¼ˆæ¨èï¼‰

1. ç™»å½• [Supabase Dashboard](https://app.supabase.com)
2. é€‰æ‹©æ‚¨çš„é¡¹ç›®
3. è¿›å…¥ **SQL Editor**
4. æ‰“å¼€å¹¶æ‰§è¡Œï¼š`MenuApp/database/youtube_cache_tables.sql`

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„è¡¨
- åˆ›å»ºç´¢å¼•
- è®¾ç½® RLS ç­–ç•¥ï¼ˆåŒ…æ‹¬è¯»å†™æƒé™ï¼‰

#### é€‰é¡¹ 2ï¼šå¦‚æœè¡¨å·²å­˜åœ¨ä½†ç¼ºå°‘å†™å…¥æƒé™

å¦‚æœè¡¨å·²ç»åˆ›å»ºï¼Œä½†é‡åˆ° "row-level security policy" é”™è¯¯ï¼Œæ‰§è¡Œï¼š

`MenuApp/database/youtube_cache_rls_fix.sql`

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- æ·»åŠ  INSERT/UPDATE/DELETE ç­–ç•¥
- å…è®¸åŒ¿åç”¨æˆ·å†™å…¥ç¼“å­˜æ•°æ®

## è¿è¡Œæµ‹è¯•

### åŸºæœ¬æµ‹è¯•

```bash
cd MenuApp/server
npm run test:cache
```

### å®Œæ•´æµ‹è¯•ï¼ˆåŒ…å«æ¸…ç†ï¼‰

```bash
cd MenuApp/server
npm run test:cache:cleanup
```

## æµ‹è¯•è¦†ç›–

æµ‹è¯•è„šæœ¬ä¼šéªŒè¯ï¼š

1. âœ… **æ•°æ®åº“è¿æ¥** - éªŒè¯ Supabase è¿æ¥å’Œè¡¨å­˜åœ¨
2. âœ… **å­˜å‚¨åŠŸèƒ½** - æµ‹è¯•å­˜å‚¨æŸ¥è¯¢ã€è§†é¢‘å’Œå…³é”®è¯
3. âœ… **æŸ¥æ‰¾åŠŸèƒ½** - æµ‹è¯•ç²¾ç¡®åŒ¹é…ç¼“å­˜æŸ¥è¯¢
4. âœ… **è§„èŒƒåŒ–** - éªŒè¯æŸ¥è¯¢å­—ç¬¦ä¸²è§„èŒƒåŒ–
5. âœ… **æ¸…ç†** - å¯é€‰çš„æ•°æ®æ¸…ç†åŠŸèƒ½

## å·²çŸ¥é—®é¢˜

### é—®é¢˜ 1ï¼šRLS ç­–ç•¥é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
new row violates row-level security policy for table "youtube_queries"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ‰§è¡Œ `MenuApp/database/youtube_cache_rls_fix.sql` æˆ–é‡æ–°æ‰§è¡Œå®Œæ•´çš„ `youtube_cache_tables.sql`

### é—®é¢˜ 2ï¼šæŸ¥è¯¢è§„èŒƒåŒ–å·®å¼‚

**è¯´æ˜**ï¼š
- `"stir-fry"` ä¼šè¢«è§„èŒƒåŒ–ä¸º `"stirfry"`ï¼ˆè¿å­—ç¬¦è¢«ç§»é™¤ï¼‰
- `"stir fry"` ä¼šè¢«è§„èŒƒåŒ–ä¸º `"stir fry"`ï¼ˆç©ºæ ¼ä¿ç•™ï¼‰
- å› æ­¤è¿™ä¸¤ä¸ªæŸ¥è¯¢ä¼šäº§ç”Ÿä¸åŒçš„å“ˆå¸Œå€¼

**è¿™æ˜¯é¢„æœŸè¡Œä¸º**ï¼Œå› ä¸ºï¼š
- è§„èŒƒåŒ–ç§»é™¤äº†ç‰¹æ®Šå­—ç¬¦ï¼ˆåŒ…æ‹¬è¿å­—ç¬¦ï¼‰
- ä¸åŒçš„æ‹¼å†™æ–¹å¼ç¡®å®åº”è¯¥è¢«è§†ä¸ºä¸åŒçš„æŸ¥è¯¢
- å¦‚æœéœ€è¦åŒ¹é…ï¼Œå¯ä»¥åœ¨é˜¶æ®µ2çš„ç›¸ä¼¼åº¦åŒ¹é…ä¸­å¤„ç†

## ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼š

1. **å¯åŠ¨æœåŠ¡å™¨**
   ```bash
   npm start
   ```

2. **æµ‹è¯•å®é™…åŠŸèƒ½**
   - ç”Ÿæˆä¸€ä¸ªèœè°±
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ä¸­çš„ç¼“å­˜å‘½ä¸­æƒ…å†µ
   - éªŒè¯ç¬¬äºŒæ¬¡æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨ç¼“å­˜

3. **ç›‘æ§ç¼“å­˜æ•ˆæœ**
   - æŸ¥çœ‹ `youtube_queries` è¡¨ä¸­çš„ `use_count` å­—æ®µ
   - æ£€æŸ¥ API è°ƒç”¨æ˜¯å¦å‡å°‘

4. **å‡†å¤‡é˜¶æ®µ2**
   - ç›¸ä¼¼åº¦åŒ¹é…åŠŸèƒ½
   - å…³é”®è¯åŒ¹é…
   - æ™ºèƒ½æ¨è

## æµ‹è¯•è¾“å‡ºç¤ºä¾‹

æˆåŠŸè¿è¡Œçš„è¾“å‡ºåº”è¯¥ç±»ä¼¼ï¼š

```
ğŸš€ Starting YouTube Cache Tests (Stage 1: Exact Match)
==================================================

ğŸ“‹ Test 1: Database Connection
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Database connection successful
âœ… Table youtube_queries exists

ğŸ“‹ Test 2: Store YouTube Query
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Query record created
âœ… Stored 2 videos
âœ… Stored 3 keywords

ğŸ“‹ Test 3: Find Cached Query
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Found cached query
âœ… Usage statistics updated

ğŸ“‹ Test 4: Query Normalization
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… 4/5 variations produce the same hash

==================================================
ğŸ“Š Test Summary
==================================================
Database Connection: âœ… PASS
Store Query:         âœ… PASS
Find Cached Query:   âœ… PASS
Query Variations:    âœ… PASS

ğŸ‰ All tests passed! Stage 1 implementation is working correctly.
```

