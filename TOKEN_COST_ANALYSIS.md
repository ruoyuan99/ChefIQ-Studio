# Token 消耗和成本分析

## 当前实现：两阶段生成

### Stage 1: 概念生成（Concept Outlines）

**模型**: `gpt-4o` (默认) 或 `gpt-4o-mini` (如果设置)
**参数**:
- `temperature: 0.85`
- `max_tokens: 2000`
- 无 JSON Schema（自然语言输出）

**Prompt 长度估算**:
- System message: ~200 tokens
- User prompt: ~800-1200 tokens（取决于用户输入）
- **总输入**: ~1000-1400 tokens

**输出长度估算**:
- 3 个概念，每个概念 ~300-400 tokens
- **总输出**: ~900-1200 tokens

**Stage 1 总消耗**: ~1900-2600 tokens

### Stage 2: 详细食谱生成（Detailed Recipes）

**模型**: `gpt-4o` (默认) 或 `gpt-4o-mini` (如果设置)
**参数**:
- `temperature: 0.7`
- JSON Schema (structured output)
- 无 `max_tokens` 限制（使用默认）

**Prompt 长度估算**:
- System message: ~1200 tokens（包含所有规则）
- User prompt: 
  - 如果使用 Stage 1 概念: ~500-800 tokens（概念 + 要求）
  - 如果单阶段（fallback）: ~2500-3500 tokens（完整 prompt）
- **总输入**: 
  - 两阶段模式: ~1700-2000 tokens
  - 单阶段模式: ~3700-4700 tokens

**输出长度估算**:
- 3 个完整食谱，每个食谱 ~800-1200 tokens
- JSON 格式
- **总输出**: ~2400-3600 tokens

**Stage 2 总消耗**: 
- 两阶段模式: ~4100-5600 tokens
- 单阶段模式: ~6100-8300 tokens

### YouTube 视频推荐

**模型**: `gpt-4o-mini` (已使用)
**参数**:
- `temperature: 0.8`
- `max_tokens: 1200`
- JSON format

**Prompt 长度估算**:
- System message: ~150 tokens
- User prompt: ~400-600 tokens
- **总输入**: ~550-750 tokens

**输出长度估算**:
- 2 个视频推荐，每个 ~200-300 tokens
- **总输出**: ~400-600 tokens

**YouTube 推荐总消耗**: ~950-1350 tokens

## 每次用户查询的总 Token 消耗

### 两阶段模式（推荐）

| 阶段 | 输入 Tokens | 输出 Tokens | 总 Tokens |
|------|------------|------------|-----------|
| Stage 1 (概念) | ~1000-1400 | ~900-1200 | ~1900-2600 |
| Stage 2 (食谱) | ~1700-2000 | ~2400-3600 | ~4100-5600 |
| YouTube (3个食谱 × 1次) | ~550-750 | ~400-600 | ~950-1350 |
| **总计** | **~3250-4150** | **~3700-5400** | **~6950-9550** |

### 单阶段模式（Fallback）

| 阶段 | 输入 Tokens | 输出 Tokens | 总 Tokens |
|------|------------|------------|-----------|
| Stage 2 (食谱) | ~3700-4700 | ~2400-3600 | ~6100-8300 |
| YouTube (3个食谱 × 1次) | ~550-750 | ~400-600 | ~950-1350 |
| **总计** | **~4250-5450** | **~2800-4200** | **~7050-9650** |

**平均每次查询**: ~8000 tokens（两阶段模式）

## 成本对比：GPT-4o vs GPT-4o-mini

### GPT-4o 定价（2024年）
- **输入**: $2.50 / 1M tokens
- **输出**: $10.00 / 1M tokens

### GPT-4o-mini 定价（2024年）
- **输入**: $0.15 / 1M tokens
- **输出**: $0.60 / 1M tokens

### 成本计算（每次用户查询）

#### 使用 GPT-4o（当前配置）

**两阶段模式**:
- Stage 1: 1400 input × $2.50/1M + 1200 output × $10.00/1M = $0.0035 + $0.012 = **$0.0155**
- Stage 2: 2000 input × $2.50/1M + 3600 output × $10.00/1M = $0.005 + $0.036 = **$0.041**
- YouTube: 750 input × $0.15/1M + 600 output × $0.60/1M = $0.0001 + $0.0004 = **$0.0005**
- **总计**: **~$0.057 per query**

**单阶段模式**:
- Stage 2: 4700 input × $2.50/1M + 3600 output × $10.00/1M = $0.01175 + $0.036 = **$0.04775**
- YouTube: 750 input × $0.15/1M + 600 output × $0.60/1M = $0.0001 + $0.0004 = **$0.0005**
- **总计**: **~$0.048 per query**

#### 使用 GPT-4o-mini（如果改用）

**两阶段模式**:
- Stage 1: 1400 input × $0.15/1M + 1200 output × $0.60/1M = $0.00021 + $0.00072 = **$0.00093**
- Stage 2: 2000 input × $0.15/1M + 3600 output × $0.60/1M = $0.0003 + $0.00216 = **$0.00246**
- YouTube: 750 input × $0.15/1M + 600 output × $0.60/1M = $0.0001 + $0.0004 = **$0.0005**
- **总计**: **~$0.0039 per query**

**单阶段模式**:
- Stage 2: 4700 input × $0.15/1M + 3600 output × $0.60/1M = $0.000705 + $0.00216 = **$0.002865**
- YouTube: 750 input × $0.15/1M + 600 output × $0.60/1M = $0.0001 + $0.0004 = **$0.0005**
- **总计**: **~$0.0034 per query**

### 成本节省

| 模式 | GPT-4o | GPT-4o-mini | 节省 |
|------|--------|-------------|------|
| 两阶段 | $0.057 | $0.0039 | **93%** |
| 单阶段 | $0.048 | $0.0034 | **93%** |

**每月成本估算**（假设 1000 次查询）:
- GPT-4o: $57
- GPT-4o-mini: $3.9
- **节省**: $53.1 (93%)

## 使用 GPT-4o-mini 的可行性评估

### ✅ 优点

1. **成本大幅降低**: 93% 成本节省
2. **速度更快**: GPT-4o-mini 响应速度更快
3. **足够的能力**: 对于结构化输出（JSON Schema），mini 模型通常表现良好

### ⚠️ 潜在问题

1. **食谱质量**: 
   - GPT-4o-mini 可能生成更简单、更通用的食谱
   - 可能不够详细或缺乏创意
   - 可能更容易生成 "Supper", "Feast", "Showcase" 这样的通用标题

2. **规则遵循**:
   - 可能不如 GPT-4o 严格遵循复杂的规则
   - 可能忽略某些约束条件

3. **多样性**:
   - 可能生成的三个食谱差异不够大
   - 可能缺乏创意和独特性

### 🔄 混合方案（推荐）

**建议**: 使用 GPT-4o-mini 进行 Stage 1（概念生成），使用 GPT-4o 进行 Stage 2（详细食谱生成）

**理由**:
- Stage 1 只需要生成概念，不需要太详细，mini 模型足够
- Stage 2 需要生成完整的、详细的、真实的食谱，GPT-4o 质量更高
- 成本节省: ~27%（Stage 1 使用 mini）

**成本计算（混合方案）**:
- Stage 1 (mini): $0.00093
- Stage 2 (gpt-4o): $0.041
- YouTube (mini): $0.0005
- **总计**: **~$0.042 per query**（节省 26%）

## 测试建议

### 1. 小规模测试 GPT-4o-mini

**测试方案**:
1. 设置 `OPENAI_MODEL_RECIPE=gpt-4o-mini` 在 `.env` 中
2. 生成 10-20 个食谱
3. 评估质量：
   - 标题多样性
   - 食谱详细程度
   - 真实性
   - 规则遵循情况

### 2. 混合方案测试

**测试方案**:
1. Stage 1 使用 `gpt-4o-mini`
2. Stage 2 使用 `gpt-4o`
3. 评估质量是否可接受

### 3. 质量对比

**对比指标**:
- 标题多样性（是否避免 "Supper", "Feast", "Showcase"）
- 食谱详细程度（指令数量、具体性）
- 真实性（是否像真实食谱）
- 用户满意度

## 推荐方案

### 方案 A: 完全使用 GPT-4o-mini（最省钱）

**配置**:
```bash
OPENAI_MODEL_RECIPE=gpt-4o-mini
```

**成本**: $0.0039 per query
**风险**: 质量可能下降

### 方案 B: 混合方案（推荐）

**配置**:
- Stage 1: `gpt-4o-mini`
- Stage 2: `gpt-4o`

**需要代码修改**: 为 Stage 1 单独设置模型
**成本**: $0.042 per query（节省 26%）
**质量**: 接近完全使用 GPT-4o

### 方案 C: 完全使用 GPT-4o（当前，质量最高）

**配置**:
```bash
OPENAI_MODEL_RECIPE=gpt-4o
```

**成本**: $0.057 per query
**质量**: 最高

## 结论

1. **当前成本**: ~$0.057 per query（使用 GPT-4o）
2. **使用 mini 可节省**: 93% 成本（$0.0039 per query）
3. **推荐**: 先测试 GPT-4o-mini，如果质量可接受，则使用 mini；如果质量不够，考虑混合方案

